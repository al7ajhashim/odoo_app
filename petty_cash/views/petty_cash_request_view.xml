<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <record id="view_petty_confirm_settlement_form" model="ir.ui.view">
        <field name="name">petty.cash.request Confirm Settlement Form</field>
        <field name="model">petty.cash.request</field>
        <field name="priority">100000000</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <div>
                        <p>
                            Press <b>CONFIRM</b> to reconcile the petty cash.<br/>
                        </p>
                    </div>
                </sheet>
                <footer>
                  <button name="confirm_settlement" type="object" string="Confirm" class="oe_highlight"/>
                  <button class="btn btn-secondary oe_button oe_form_button" special="cancel" string="Cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="view_petty_request_form" model="ir.ui.view">
        <field name="name">petty.cash.request Form</field>
        <field name="model">petty.cash.request</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <field name="state" widget="statusbar" statusbar_visible="draft,approval,complete"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" no_label="1" readonly="1" force_save="1"/>
                        </h1>
                    </div>
                    <group string="Request Info">
                        <group>
                            <field name="by_employee" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="requester_emp_id" attrs="{'invisible': [('by_employee', '=', False)], 'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="requester_partner_id" attrs="{'invisible': [('by_employee', '!=', False)], 'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="narration" placeholder="Petty cash expenses of ..." attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                        </group>
                        <group>
                            <field name="order_date" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="approve_date" readonly="1"/>
                        </group>
                        <group>
                            <field name="amount" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                        </group>
                        <group>
                            <field name="settlement_amount"/>
                            <field name="different_amount"/>
                        </group>
                    </group>
                    <notebook>
                        <page name="settlement"  string="Settlement" groups="account.group_account_user" attrs="{'invisible': [('state', '!=', 'complete')]}">

                            <field name="settlement_ids" widget="one2many_list" nolabel="1" colspan="4" attrs="{'readonly': [('state', '!=', 'complete')]}">
                                <tree string="Settlement" editable="bottom">
                                    <field name="petty_request_id" invisible="1"/>
                                    <field name="bill_id" width="25%"/>
                                    <field name="expense_id" width="25%"/>
                                    <field name="product_id"
                                           attrs="{'required': [('bill_id', '!=', False), ('expense_id', '!=', False)]}"
                                           context="{'default_can_be_expensed': 1}"/>
                                    <field name="name" width="30%"/>
                                    <field name="expense_account_id"
                                           width="25%"
                                           attrs="{'readonly': ['|', ('bill_id', '!=', False), ('expense_id', '!=', False)]}"/>
                                    <field name="amount" width="20%"/>
                                </tree>
                            </field>

                            <field name="attachment_ids" widget="many2many_binary" string="Attach a file" class="oe_inline"/>

                        </page>
                    </notebook>
                    <separator string="Notes" colspan="4"/>
                    <field name="note" placeholder="Notes..."/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers" groups="base.group_user"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <record id="view_petty_approval_form" model="ir.ui.view">
        <field name="name">petty.cash.approval Form</field>
        <field name="model">petty.cash.request</field>
        <field name="priority">1000000</field>
        <field name="arch" type="xml">
            <form>
                <field name="in_settlement" invisible="1"/>
                <field name="settlement_state" invisible="1"/>
                <field name="has_request_not_reconciled" invisible="1"/>
                <header>
                    <button name="action_approve" type="object" string="Approve" class="btn-primary" states="draft" groups="account.group_account_user"/>
                    <button name="action_reject" type="object" string="Reject" class="btn-default" states="draft" groups="account.group_account_user"/>
                    <button name="action_draft" type="object" string="Reset to Draft" class="btn-default" states="reject" groups="account.group_account_user"/>
                    <button name="open_wizard_operation" type="object" string="Register Petty Cash" class="btn-primary" states="approval" groups="account.group_account_user"/>

                    <button name="petty_cash_settlement"
                            type="object"
                            string="Reconcile" class="btn-primary"
                            attrs="{'invisible': ['|', ('state', '!=', 'complete'), ('in_settlement', '=', False)]}"
                            groups="account.group_account_user"/>

                    <button name="open_wizard_operation" type="object"
                            string="Return Petty Cash Remaining" class="btn-default"
                            attrs="{'invisible': ['|', ('state', '!=', 'complete'), ('settlement_state', '!=', 'partial')]}"
                            groups="account.group_account_user"/>
                    <button name="open_wizard_operation" type="object" invisible="1"
                            string="Register Petty Cash Intemperance" class="btn-default"
                            attrs="{'invisible': ['|', ('state', '!=', 'complete'), ('settlement_state', '!=', 'full')]}"
                            groups="account.group_account_user"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,approval,complete"/>
                </header>

                <div class="alert alert-warning mb-0" role="alert" attrs="{'invisible': [('has_request_not_reconciled', '=', False)]}">
                    <strong>Warning:</strong> This request cannot be approved because this partner has already petty cash isn't full reconciled
                </div>

                <sheet>

                    <div name="button_box" class="oe_button_box">
                        <button name="open_reconcile_view" class="oe_stat_button" icon="fa-bars" type="object" attrs="{'invisible': [('state', '!=', 'complete')]}" string="Reconciled Entries">
                        </button>
                    </div>

                    <widget name="web_ribbon" title="Partial Settlement" attrs="{'invisible': [('settlement_state', '!=', 'partial')]}"/>
                    <widget name="web_ribbon" title="Full Settlement" attrs="{'invisible': [('settlement_state', '!=', 'full')]}"/>

                    <div class="col-12 oe_centered text-center">
                        <h2>
                            <field name="different_amount" readonly="1"/> -
                            <field name="narration" readonly="1"/>
                            ( <field name="name" no_label="1" readonly="1" force_save="1"/> )
                        </h2>
                    </div>

                    <group string="Request Information">
                        <group>
                            <field name="by_employee" invisible="1"/>
                            <field name="requester_emp_id" readonly="1" attrs="{'invisible': [('by_employee', '=', False)]}"/>
                            <field name="requester_partner_id" readonly="1" attrs="{'invisible': [('by_employee', '!=', False)]}"/>
                        </group>
                        <group readonly="1">
                            <field name="order_date" readonly="1"/>
                            <field name="approve_date" readonly="1"/>
                        </group>
                        <group>
                            <field name="amount"/>
                        </group>
                        <group>
                            <field name="settlement_amount" readonly="1"/>
                        </group>
                    </group>
                    <group>
                        <group string="Accounting Information" groups="account.group_account_user">
                            <field name="petty_cash_journal_id"
                                   readonly="1" force_save="1"
                                   options="{'no_open': True, 'no_create': True}"
                                   groups="account.group_account_user"/>
                            <field name="operation_journal_id" widget="selection" groups="account.group_account_user"/>
                            <field name="operation_account_id"
                                   readonly="1" force_save="1"
                                   groups="account.group_account_user"/>
                            <field name="move_id" readonly="1" groups="account.group_account_user"/>
                        </group>
                        <group string="Analytic Information" groups="account.group_account_user">
                            <field name="use_analytic" groups="account.group_account_user"/>
                            <field name="analytic_account_id"
                                   attrs="{'invisible': [('use_analytic', '=', False)]}"
                                   groups="analytic.group_analytic_accounting"/>
                            <field name="analytic_tag_ids"
                                   attrs="{'invisible': [('use_analytic', '=', False)]}"
                                   groups="analytic.group_analytic_accounting" widget="many2many_tags"/>
                        </group>
                    </group>
                    <notebook>
                        <page name="settlement"  string="Settlement" groups="account.group_account_user" attrs="{'invisible': [('state', '!=', 'complete')]}">
                            <field name="settlement_ids" widget="one2many_list" nolabel="1" colspan="4" attrs="{'readonly': [('state', '!=', 'complete')]}">
                                <tree string="Settlement" editable="bottom">
                                    <field name="petty_request_id" invisible="1"/>
                                    <field name="bill_id"/>
                                    <field name="expense_id"/>
                                    <field name="product_id"
                                           attrs="{'required': [('bill_id', '=', False), ('expense_id', '=', False)]}"
                                           context="{'default_can_be_expensed': 1}"/>
                                    <field name="name"/>
                                    <field name="expense_account_id" force_save="1"
                                           attrs="{'readonly': ['|', ('bill_id', '!=', False), ('expense_id', '!=', False)]}"/>
                                    <field name="amount"/>
                                </tree>
                            </field>

                            <field name="attachment_ids" widget="many2many_binary" string="Attach a file" class="oe_inline"/>
                        </page>
                    </notebook>
                    <separator string="Notes" colspan="4"/>
                    <field name="note" placeholder="Notes..."/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers" groups="base.group_user"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <record id="view_petty_request_tree" model="ir.ui.view">
        <field name="name">petty.cash.request Tree</field>
        <field name="model">petty.cash.request</field>
        <field name="arch" type="xml">
            <tree>
                <field name="name"/>
                <field name="narration"/>
                <field name="amount"/>
                <field name="settlement_state" widget="badge" decoration-info="settlement_state == 'no'" decoration-warning="settlement_state == 'partial'" decoration-success="settlement_state == 'full'"/>
                <field name="state"/>
            </tree>
        </field>
    </record>

    <record id="view_petty_approval_tree" model="ir.ui.view">
        <field name="name">petty.cash.approval Tree</field>
        <field name="model">petty.cash.request</field>
        <field name="priority">1000000</field>
        <field name="arch" type="xml">
            <tree>
                <field name="name"/>
                <field name="narration"/>
                <field name="amount"/>
                <field name="settlement_amount"/>
                <field name="different_amount"/>
                <field name="settlement_state" widget="badge" decoration-info="settlement_state == 'no'" decoration-warning="settlement_state == 'partial'" decoration-success="settlement_state == 'full'"/>
                <field name="state"/>
            </tree>
        </field>
    </record>

    <record id="action_petty_request_open_my" model="ir.actions.act_window">
        <field name="name">My Petty Cash Requests</field>
        <field name="res_model">petty.cash.request</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('user_id', '=', uid)]</field>
    </record>

    <record id="action_petty_open_approval" model="ir.actions.act_window">
        <field name="name">Approval</field>
        <field name="res_model">petty.cash.request</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'group_by':['requester_partner_id']}</field>
    </record>

    <record id="action_petty_open_approval_view_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="view_petty_approval_tree"/>
        <field name="act_window_id" ref="action_petty_open_approval"/>
    </record>

    <record id="action_petty_open_approval_view_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_petty_approval_form"/>
        <field name="act_window_id" ref="action_petty_open_approval"/>
    </record>

    <menuitem id="menu_open_petty_request_my"
              parent="petty_cash.menu_petty_orders"
              action="action_petty_request_open_my"
              sequence="1"/>

    <menuitem id="menu_open_petty_approval"
              parent="petty_cash.menu_petty_orders"
              action="action_petty_open_approval"
               groups="account.group_account_user"
              sequence="2"/>

</odoo>
